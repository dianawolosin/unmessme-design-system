#!/bin/bash

# UnmessMe MCP - Benchmark Setup Script
# This script creates the directory structure for testing 4 different formats

set -e

echo "ðŸš€ Setting up UnmessMe Benchmark Test Environment..."
echo ""

# Get the script directory
SCRIPT_DIR="$( cd "$( dirname "${BASH_SOURCE[0]}" )" && pwd )"
MCP_DIR="$( cd "$SCRIPT_DIR/.." && pwd )"
ROOT_DIR="$( cd "$MCP_DIR/../.." && pwd )"

echo "ðŸ“ Root Directory: $ROOT_DIR"
echo "ðŸ“ MCP Directory: $MCP_DIR"
echo ""

# Create test-data directory structure
TEST_DATA_DIR="$MCP_DIR/test-data"
mkdir -p "$TEST_DATA_DIR"

echo "âœ… Creating test data directories..."

# Test 1: JSON + MD (YAML) - Baseline (just symlink to existing data)
TEST_1_DIR="$TEST_DATA_DIR/test-1-json-md-yaml"
mkdir -p "$TEST_1_DIR"
echo "  ðŸ“‚ Test 1: JSON + MD (YAML) - Baseline"

# Symlink existing component specs
if [ -d "$ROOT_DIR/packages/design-system/component-specs" ]; then
  ln -sf "$ROOT_DIR/packages/design-system/component-specs" "$TEST_1_DIR/components"
  echo "    âœ“ Linked component specs"
else
  echo "    âš ï¸  Component specs not found, creating placeholder"
  mkdir -p "$TEST_1_DIR/components"
fi

# Symlink existing tokens
if [ -d "$ROOT_DIR/packages/design-system/src/tokens" ]; then
  ln -sf "$ROOT_DIR/packages/design-system/src/tokens" "$TEST_1_DIR/tokens"
  echo "    âœ“ Linked tokens"
else
  echo "    âš ï¸  Tokens not found, creating placeholder"
  mkdir -p "$TEST_1_DIR/tokens"
fi

# Test 2: Toon + MD (to be generated)
TEST_2_DIR="$TEST_DATA_DIR/test-2-toon-md"
mkdir -p "$TEST_2_DIR/components"
mkdir -p "$TEST_2_DIR/tokens"
echo "  ðŸ“‚ Test 2: Toon + MD"
echo "    â³ Data will be generated by transformation scripts"

# Test 3: Pure MD (to be generated)
TEST_3_DIR="$TEST_DATA_DIR/test-3-pure-md"
mkdir -p "$TEST_3_DIR/components"
mkdir -p "$TEST_3_DIR/tokens"
echo "  ðŸ“‚ Test 3: Pure MD"
echo "    â³ Data will be generated by transformation scripts"

# Test 4: Monolithic JSON (to be generated or copied from company data)
TEST_4_DIR="$TEST_DATA_DIR/test-4-mono-json"
mkdir -p "$TEST_4_DIR/components"
mkdir -p "$TEST_4_DIR/tokens"
echo "  ðŸ“‚ Test 4: Monolithic JSON"
echo "    â³ Data will be generated by transformation scripts OR copied from company data"

echo ""
echo "âœ… Test data directories created!"
echo ""

# Create a README in test-data
cat > "$TEST_DATA_DIR/README.md" << 'EOF'
# UnmessMe Benchmark Test Data

This directory contains the test data for the 4 format benchmark experiments.

## Directory Structure

```
test-data/
â”œâ”€â”€ test-1-json-md-yaml/    # Baseline: JSON tokens + MD specs (YAML frontmatter)
â”‚   â”œâ”€â”€ components/         # Symlink to packages/design-system/component-specs
â”‚   â””â”€â”€ tokens/             # Symlink to packages/design-system/src/tokens
â”œâ”€â”€ test-2-toon-md/         # Toon tokens + MD specs (Toon frontmatter)
â”‚   â”œâ”€â”€ components/         # Generated by yaml-to-toon.ts
â”‚   â””â”€â”€ tokens/             # Generated by json-to-toon.ts
â”œâ”€â”€ test-3-pure-md/         # Pure Markdown (no frontmatter, no JSON)
â”‚   â”œâ”€â”€ components/         # Generated by strip-frontmatter.ts
â”‚   â””â”€â”€ tokens/             # Generated by json-to-markdown.ts
â””â”€â”€ test-4-mono-json/       # Monolithic JSON (everything nested)
    â”œâ”€â”€ components/         # Generated by md-to-monolithic-json.ts OR copied from company
    â””â”€â”€ tokens/             # Nested in component JSON
```

## Usage

### Generate Test Data

```bash
# Test 2: Convert to Toon format
npm run transform:test2

# Test 3: Convert to Pure MD
npm run transform:test3

# Test 4: Convert to Monolithic JSON (or copy from company data)
npm run transform:test4
```

### Run Benchmarks

```bash
# Token efficiency test (all formats)
npm run benchmark:tokens

# Chunk inspection (specific format)
npm run benchmark:chunks -- --test=1

# Retrieval precision (all formats)
npm run benchmark:retrieval
```

## Notes

- Test 1 uses symlinks to avoid duplication
- Tests 2-4 require transformation scripts (to be implemented)
- All results are documented in `BENCHMARK_RESULTS.md`
EOF

echo "ðŸ“ Created test-data/README.md"
echo ""

# Create placeholder transformation scripts
TRANSFORMERS_DIR="$MCP_DIR/src/utils/transformers"
mkdir -p "$TRANSFORMERS_DIR"

echo "âœ… Creating placeholder transformation scripts..."

# Placeholder for Test 2 transformers
cat > "$TRANSFORMERS_DIR/yaml-to-toon.ts" << 'EOF'
/**
 * Test 2 Transformer: YAML frontmatter â†’ Toon frontmatter
 * 
 * Converts component specs from YAML frontmatter to Toon format
 */

export async function yamlToToon(inputDir: string, outputDir: string): Promise<void> {
  // TODO: Implement YAML â†’ Toon conversion
  console.log('Converting YAML frontmatter to Toon...');
  console.log(`Input: ${inputDir}`);
  console.log(`Output: ${outputDir}`);
}
EOF

cat > "$TRANSFORMERS_DIR/json-to-toon.ts" << 'EOF'
/**
 * Test 2 Transformer: JSON tokens â†’ Toon tokens
 * 
 * Converts token JSON files to Toon format
 */

export async function jsonToToon(inputDir: string, outputDir: string): Promise<void> {
  // TODO: Implement JSON â†’ Toon conversion
  console.log('Converting JSON tokens to Toon...');
  console.log(`Input: ${inputDir}`);
  console.log(`Output: ${outputDir}`);
}
EOF

# Placeholder for Test 3 transformers
cat > "$TRANSFORMERS_DIR/strip-frontmatter.ts" << 'EOF'
/**
 * Test 3 Transformer: Strip YAML frontmatter
 * 
 * Removes YAML frontmatter from component specs
 */

export async function stripFrontmatter(inputDir: string, outputDir: string): Promise<void> {
  // TODO: Implement frontmatter stripping
  console.log('Stripping YAML frontmatter...');
  console.log(`Input: ${inputDir}`);
  console.log(`Output: ${outputDir}`);
}
EOF

cat > "$TRANSFORMERS_DIR/json-to-markdown.ts" << 'EOF'
/**
 * Test 3 Transformer: JSON tokens â†’ Markdown tables
 * 
 * Converts token JSON files to Markdown tables
 */

export async function jsonToMarkdown(inputDir: string, outputDir: string): Promise<void> {
  // TODO: Implement JSON â†’ Markdown conversion
  console.log('Converting JSON tokens to Markdown tables...');
  console.log(`Input: ${inputDir}`);
  console.log(`Output: ${outputDir}`);
}
EOF

# Placeholder for Test 4 transformer
cat > "$TRANSFORMERS_DIR/md-to-monolithic-json.ts" << 'EOF'
/**
 * Test 4 Transformer: MD specs â†’ Monolithic JSON
 * 
 * Converts component specs to deep nested JSON structure
 */

export async function mdToMonolithicJson(inputDir: string, outputDir: string): Promise<void> {
  // TODO: Implement MD â†’ Monolithic JSON conversion
  console.log('Converting MD specs to Monolithic JSON...');
  console.log(`Input: ${inputDir}`);
  console.log(`Output: ${outputDir}`);
}
EOF

echo "  âœ“ Created yaml-to-toon.ts"
echo "  âœ“ Created json-to-toon.ts"
echo "  âœ“ Created strip-frontmatter.ts"
echo "  âœ“ Created json-to-markdown.ts"
echo "  âœ“ Created md-to-monolithic-json.ts"
echo ""

echo "ðŸŽ‰ Benchmark setup complete!"
echo ""
echo "ðŸ“‹ Next Steps:"
echo "  1. Implement transformation scripts in src/utils/transformers/"
echo "  2. Run transformations to generate test data for Tests 2-4"
echo "  3. Execute benchmark phases (token efficiency, chunk inspection, retrieval)"
echo "  4. Document results in BENCHMARK_RESULTS.md"
echo ""
echo "ðŸ“š See test-data/README.md for usage instructions"
echo ""

